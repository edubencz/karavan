- route:
    id: route-efetua-oauth-banco
    from:
      id: from-route-efetua-oauth-banco
      uri: direct
      parameters:
        name: route-efetua-oauth-banco
      steps:
        - log:
            id: log-ab81
            description: "# ROUTE-route-efetua-oauth-banco #"
            message: "# ROUTE-route-efetua-oauth-banco #"
        - choice:
            id: choice-71cc
            description: Geração de Certificado
            when:
              - id: when-62c1
                description: Existe Certificado
                expression:
                  simple:
                    id: simple-d539
                    expression: >-
                      ${exchangeProperty.bancoPayloadDados[certificate]} != null
                      && ${exchangeProperty.bancoPayloadDados[certificate].trim}
                      != ''
                steps:
                  - log:
                      id: log-f18d
                      description: "# GERA CERTIFICADO #"
                      message: "# GERA CERTIFICADO #"
                  - bean:
                      id: bean-f5f9
                      description: "Bean: criarArquivoCertificado"
                      ref: certificadoArquivo
                      method: criarArquivoCertificado
                  - setProperty:
                      id: setProperty-0f32
                      description: "Var Certificado: sslBeanId"
                      name: sslBeanId
                      expression:
                        simple:
                          id: simple-9966
                          expression: ${body}
                  - setProperty:
                      id: setProperty-346d
                      description: "Var: securityContext"
                      name: securityContext
                      expression:
                        simple:
                          id: simple-4d2a
                          expression: ${exchangeProperty.sslBeanId}
                  - log:
                      id: log-5bcb
                      description: "# ARQ. CERT. GERADO PELO JAVA#"
                      message: "# ARQ. CERT. GERADO PELO JAVA#"
            otherwise:
              id: otherwise-1b5b
              steps:
                - log:
                    id: log-9214
                    description: "# NÃO EXISTE CERTIFICADO #"
                    message: "# NÃO EXISTE CERTIFICADO #"
        - setHeader:
            id: setHeader-8770
            description: "Header: Content-Type"
            name: Content-Type
            expression:
              simple:
                id: simple-5ce1
                expression: application/x-www-form-urlencoded
        - log:
            id: log-f2fa
            description: "# VALIDA BANCO PARA AUTH2 #"
            message: >-
              # VALIDA BANCO PARA AUTH2 # Banco:
              ${exchangeProperty.rota[codigoBanco]} == 1
        - choice:
            id: choice-auth2-identifica-banco
            when:
              - id: when-auth2-bb
                description: BB (1)
                expression:
                  simple:
                    id: simple-a0b6
                    expression: ${exchangeProperty.rota[codigoBanco]} == 1
                steps:
                  - setHeaders:
                      id: setHeaders-2cb9
                      headers:
                        - id: setHeader-392d
                          name: Authorization
                          expression:
                            simple:
                              id: simple-7f7d
                              expression: >-
                                Basic
                                ${exchangeProperty.bancoPayloadDados[clientSecret]}
                        - id: setHeader-67e2
                          name: Content-Type
                          expression:
                            simple:
                              id: simple-b51f
                              expression: application/x-www-form-urlencoded
                  - setBody:
                      id: setBody-auth2-bb-scopes
                      expression:
                        simple:
                          id: simple-8bb0
                          expression: grant_type=client_credentials&scopes={{bb_scope}}
              - id: when-a865
                description: Santander (33)
                expression:
                  simple:
                    id: simple-c13b
                    expression: ${exchangeProperty.rota[codigoBanco]} == 33
                steps:
                  - removeHeaders:
                      id: removeHeaders-2e1a
                      pattern: "*"
                  - setBody:
                      id: setBody-2d3d
                      expression:
                        simple:
                          id: simple-a586
                          expression: >-
                            grant_type=${exchangeProperty.bancoPayloadDados[grantType]}&client_secret=${exchangeProperty.bancoPayloadDados[clientSecret]}&client_id=${exchangeProperty.bancoPayloadDados[clientId]}
                  - setHeader:
                      id: setHeader-santander-ssl-certificate
                      description: "Host: Santander"
                      name: Host
                      expression:
                        simple:
                          id: simple-santander-certificate
                          expression: trust-sandbox.api.santander.com.br
              - id: when-334f
                description: Itau (341)
                expression:
                  simple:
                    id: simple-3f18
                    expression: ${exchangeProperty.rota[codigoBanco]} == 341
                steps:
                  - setBody:
                      id: setBody-a928
                      expression:
                        simple:
                          id: simple-2942
                          expression: >-
                            grant_type=${exchangeProperty.bancoPayloadDados[grantType]}&client_secret=${exchangeProperty.bancoPayloadDados[clientSecret]}&client_id=${exchangeProperty.bancoPayloadDados[clientId]}
              - id: when-cd7b
                description: Sicredi (748)
                expression:
                  simple:
                    id: simple-6c66
                    expression: ${exchangeProperty.rota[codigoBanco]} == 748
                steps:
                  - setBody:
                      id: setBody-c6cc
                      expression:
                        simple:
                          id: simple-28a3
                          expression: >-
                            username=${exchangeProperty.bancoPayloadDados[username]}&password=${exchangeProperty.bancoPayloadDados[password]}&grant_type=${exchangeProperty.bancoPayloadDados[grant_type]}&scope=${exchangeProperty.bancoPayloadDados[Scopes]}
                  - setHeaders:
                      id: setHeaders-3a3a
                      headers:
                        - id: setHeader-1a84
                          name: x-api-key
                          expression:
                            simple:
                              id: simple-b699
                              expression: ${exchangeProperty.bancoPayloadDados[ClientID]}
                        - id: setHeader-f63c
                          name: context
                          expression:
                            simple:
                              id: simple-24c6
                              expression: COBRANCA
              - id: when-ef06
                description: Unicred (136)
                disabled: false
                expression:
                  simple:
                    id: simple-5985
                    expression: ${exchangeProperty.rota[codigoBanco]} == 136
                steps:
                  - setBody:
                      id: setBody-f021
                      expression:
                        simple:
                          id: simple-af2e
                          expression: >-
                            {"nomeUsuario":"${exchangeProperty.bancoPayloadDados[nomeUsuario]}","senha":"${exchangeProperty.bancoPayloadDados[senha]}"}
                  - setHeaders:
                      id: setHeaders-05d4
                      headers:
                        - id: setHeader-c8c7
                          name: apiKey
                          expression:
                            simple:
                              id: simple-57c4
                              expression: ${exchangeProperty.bancoPayloadDados[AppKey]}
                        - id: setHeader-d200
                          name: Content-Type
                          expression:
                            simple:
                              id: simple-dcda
                              expression: application/json
              - id: when-6c47
                description: Sicoob (756)
                expression:
                  simple:
                    id: simple-030a
                    expression: ${exchangeProperty.rota[codigoBanco]} == 756
                steps:
                  - setBody:
                      id: setBody-c673
                      expression:
                        simple:
                          id: simple-59ef
                          expression: >-
                            grant_type=client_credentials&scope=boletos_inclusao
                            boletos_consulta
                            boletos_alteracao&client_id=${exchangeProperty.bancoPayloadDados[ClinetID]}
                  - log:
                      id: log-deb4
                      description: "# NÃO FUNCIONA O AUTH SEM DOC #"
                      message: "# NÃO FUNCIONA O AUTH SEM DOC #"
              - id: when-8aed
                description: Safra (422)
                expression:
                  simple:
                    id: simple-327f
                    expression: ${exchangeProperty.rota[codigoBanco]} == 422
                steps:
                  - removeHeaders:
                      id: removeHeaders-96cb
                      pattern: "*"
                  - setHeader:
                      id: setHeader-8be4
                      disabled: false
                      name: Content-Type
                      expression:
                        simple:
                          id: simple-0dfd
                          expression: application/x-www-form-urlencoded
                  - setBody:
                      id: setBody-c9ec
                      expression:
                        simple:
                          id: simple-f22b
                          expression: >-
                            username=${exchangeProperty.bancoPayloadDados[nomeUsuario]}&password=${exchangeProperty.bancoPayloadDados[senha]}&grant_type=password&client_id=${exchangeProperty.bancoPayloadDados[ClientID]}
            otherwise:
              id: otherwise-auth2-identifica-banco
              steps:
                - setHeader:
                    id: setHeader-1851
                    name: CamelHttpResponseCode
                    expression:
                      simple:
                        id: simple-26ed
                        expression: "400"
                - setBody:
                    id: setBody-5135
                    expression:
                      simple:
                        id: simple-ed61
                        expression: >-
                          { erro: "Banco não idetificado para busca do token
                          oAuth2",

                          "codigoBanco": ${exchangeProperty.rota[codigoBanco]}

                          }
                - stop:
                    id: stop-d54d
        - log:
            id: log-a28f
            description: "# AUTH HEADERS #"
            disabled: false
            message: "# AUTH HEADERS # ${headers}"
        - log:
            id: log-2fe9
            description: "# AUTH BODY #"
            message: "# AUTH BODY # ${body}"
        - log:
            id: log-8b84
            message: ${exchangeProperty.sslBeanId}
        - stop:
            id: stop-8f85
            disabled: true
        - setProperty:
            id: setProperty-eaef
            description: bancoOAuthUrl
            disabled: true
            name: bancoOAuthUrl
            expression:
              simple:
                id: simple-4609
                expression: ${exchangeProperty.bancoPayloadDados[url_oauth]}
        - doTry:
            id: doTry-e0c4
            doCatch:
              - id: doCatch-d0a0
                exception:
                  - java.lang.Exception
                steps:
                  - log:
                      id: log-bba8
                      description: "# ERRO BUSCR TOKEN #"
                      message: "# ERRO BUSCR TOKEN #"
                  - setProperty:
                      id: setProperty-d440
                      description: "Var: errorRoute"
                      name: errorRoute
                      expression:
                        simple:
                          id: simple-8d28
                          expression: >-
                            informativo: "Erro ao autenticar com o banco",
                            route: "route-route-efetua-oauth-banco"
                  - to:
                      id: to-9fc9
                      uri: direct
                      parameters:
                        name: route-trata-erros
                  - stop:
                      id: stop-cebc
            steps:
              - choice:
                  id: choice-5587
                  when:
                    - id: when-6491
                      description: securityContext != ""
                      expression:
                        simple:
                          id: simple-cd38
                          expression: >-
                            ${exchangeProperty.securityContext} != null &&
                            ${exchangeProperty.securityContext.trim} != ''
                      steps:
                        - log:
                            id: log-4fa5
                            description: "# AUTH COM CERT #"
                            message: "# AUTH COM CERT #"
                        - toD:
                            id: to-efb5
                            uri: >-
                              https://trust-sandbox.api.santander.com.br/auth/oauth/v2/token
                            parameters:
                              httpMethod: POST
                              bridgeEndpoint: true
                              logHttpActivity: false
                              sslContextParameters: "#${exchangeProperty.sslBeanId}"
                              httpUri: ${exchangeProperty.bancoOAuthUrl}
                  otherwise:
                    id: otherwise-e094
                    steps:
                      - log:
                          id: log-badf
                          description: "# AUTH SEM CERT #"
                          message: "# AUTH SEM CERT #"
                      - toD:
                          id: to-2051
                          uri: https
                          parameters:
                            httpUri: ${exchangeProperty.bancoOAuthUrl}
                            bridgeEndpoint: true
                            httpMethod: POST
                            logHttpActivity: false
              - log:
                  id: log-6720
                  description: "# TOKEN RECEBIDO #"
                  message: "# TOKEN RECEBIDO #"
        - unmarshal:
            id: unmarshal-bb71
            json:
              id: json-5bc3
        - log:
            id: log-0097
            description: "# COMU. OAUTH2 FINALIZADA #"
            message: "# COMU. OAUTH2 FINALIZADA #"
        - choice:
            id: choice-f7f2
            when:
              - id: when-2f6f
                description: Existe access_token
                expression:
                  simple:
                    id: simple-071a
                    expression: >-
                      ${body[access_token]} != null &&
                      ${body[access_token].trim} != ''
                steps:
                  - setProperty:
                      id: setProperty-bd24
                      description: "Variavel: tokenExpiresIn"
                      name: tokenExpiresIn
                      expression:
                        simple:
                          id: simple-4596
                          expression: ${body[expires_in]}
                  - setProperty:
                      id: setProperty-aed8
                      description: "Variavel: tokenBancario"
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-c618
                          expression: ${body[access_token]}
            otherwise:
              id: otherwise-52dd
              steps:
                - setProperty:
                    id: setProperty-116d
                    description: "Unicred: tokenBancario"
                    name: tokenBancario
                    expression:
                      simple:
                        id: simple-9b58
                        expression: ${body[accessToken]}
                - setProperty:
                    id: setProperty-dc60
                    description: "Unicred: tokenExpiresIn"
                    name: tokenExpiresIn
                    expression:
                      simple:
                        id: simple-75c0
                        expression: ${body[tokenExpirationTime]}
        - log:
            id: log-064f
            description: "# ALIM. TOKENBANCARIO #"
            message: "# ALIM. TOKENBANCARIO #"
        - choice:
            id: choice-valida-recebeu-token
            disabled: false
            when:
              - id: when-e5fc
                description: RecebeuToken
                expression:
                  simple:
                    id: simple-9e45
                    expression: ${exchangeProperty.tokenBancario} != ""
                steps:
                  - log:
                      id: log-afe0
                      description: "# TOKEN RECEBIDO #"
                      message: "# TOKEN RECEBIDO #"
                  - setHeader:
                      id: setHeader-e778
                      name: CamelRedis.Key
                      expression:
                        simple:
                          id: simple-63a6
                          expression: ${exchangeProperty.redisToken}
                  - setHeader:
                      id: setHeader-6e15
                      name: CamelRedis.Timeout
                      expression:
                        simple:
                          id: simple-934c
                          expression: ${exchangeProperty.tokenExpiresIn}
                  - log:
                      id: log-5755
                      description: "# SENHA CERTIFICADO #"
                      message: >-
                        # SENHA CERTIFICADO:
                        ${exchangeProperty.bancoPayloadDados[certificatePrivateKeyPassword]}
                  - setBody:
                      id: setBody-1cd4
                      disabled: false
                      expression:
                        simple:
                          id: simple-ecb2
                          expression: >-
                            {"Senha":"${exchangeProperty.bancoSenhaCertificado}",

                            "token":"${exchangeProperty.tokenBancario}",

                            "arquivo":"${exchangeProperty.bancoArquivoCertificado}"

                            }
                  - stop:
                      id: stop-d10b
                  - to:
                      id: to-redis-set-token
                      description: CriaToken
                      uri: kamelet:redis-sink
                      parameters:
                        redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                        redisPort: 6379
                        command: SETEX
                  - log:
                      id: log-4a23
                      description: "# TOKEN SALVO NO REDIS #"
                      message: "# TOKEN SALVO NO REDIS #"
            otherwise:
              id: otherwise-5ab6
              steps:
                - setBody:
                    id: setBody-retorno-erro-banco-token
                    expression:
                      simple:
                        id: simple-c0be
                        expression: ${body}
                - stop:
                    id: stop-678a
