- rest:
    id: rest-api-pix
    post:
      - id: post-api-pix
        path: /teste
        to: direct:validar-payload
        consumes: application/json
        produces: application/json
- route:
    id: route-recebe-requisicao
    nodePrefixId: route-recebe-requisicao
    from:
      id: from-api-pix
      uri: direct
      parameters:
        name: validar-payload
      steps:
        - doTry:
            id: doTry-valida-payload
            doCatch:
              - id: doCatch-valida-payload
                exception:
                  - java.lang.Exception
                steps:
                  - convertBodyTo:
                      id: convertBodyTo-exception-string
                      type: java.lang.String
                  - setHeader:
                      id: setHeader-ca85
                      name: CamelHttpResponseCode
                      expression:
                        simple:
                          id: simple-status-400
                          expression: "400"
                  - setHeader:
                      id: setHeader-exception-content
                      name: Content-Type
                      expression:
                        constant:
                          id: constant-content-json
                          expression: application/json
                  - setBody:
                      id: setBody-exception-message
                      expression:
                        simple:
                          id: simple-exception-message
                          expression: >-
                            { "mensagem": "Erro no payload:
                            ${exception.message.replaceAll('\r?\n', ' ')}" }
                  - stop:
                      id: stop-on-exception
            steps:
              - to:
                  id: to-json-validator-schema
                  uri: json-validator
                  parameters:
                    resourceUri: file:nexdom-schema.json
              - unmarshal:
                  id: unmarshal-json
                  json:
                    id: json-unmarshal
              - setProperty:
                  id: setProperty-15ee
                  description: dadosRecebidos
                  name: dadosRecebidos
                  expression:
                    simple:
                      id: simple-5831
                      expression: ${body}
              - setProperty:
                  id: setProperty-rota
                  description: "Variavel: rota"
                  name: rota
                  expression:
                    simple:
                      id: simple-extract-rota
                      expression: ${body[rota]}
              - setProperty:
                  id: setProperty-redis-banco-key
                  description: "Variavel: redisKey"
                  name: redisKey
                  expression:
                    simple:
                      id: simple-176c
                      expression: >-
                        apipix:${exchangeProperty.rota[codigoUnimed]}:${exchangeProperty.rota[codigoBanco]}
              - setProperty:
                  id: setProperty-ffe9
                  description: "Variavel: redisToken"
                  name: redisToken
                  expression:
                    simple:
                      id: simple-d8fd
                      expression: ${exchangeProperty.redisKey}:token
              - marshal:
                  id: marshal-payload-json
                  json:
                    id: json-marshal
              - to:
                  id: to-validate-banco
                  uri: direct
                  parameters:
                    name: redis-valida-token
- route:
    id: redis-valida-token
    nodePrefixId: route-redis-valida
    from:
      id: from-route-recebe-requisicao
      uri: direct
      parameters:
        name: redis-valida-token
      steps:
        - log:
            id: log-28c0
            description: "# ROUTE: REDIS-VALIDA-TOKEN #"
            message: "# ROUTE: REDIS-VALIDA-TOKEN #"
        - setHeader:
            id: setHeader-redis-token-key
            name: CamelRedis.Key
            expression:
              simple:
                id: simple-3c0f
                expression: ${exchangeProperty.redisToken}
        - to:
            id: to-480b
            description: ExisteToken
            disabled: false
            uri: kamelet:redis-sink
            parameters:
              redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
              redisPort: 6379
              command: EXISTS
        - to:
            id: to-busca-token-redis
            uri: direct
            parameters:
              name: busca-dados-bancarios
        - choice:
            id: choice-redis-existe-token
            description: Choice:ExisteToken
            when:
              - id: when-a54b
                expression:
                  simple:
                    id: simple-97dd
                    expression: ${body} == true
                steps:
                  - to:
                      id: to-95c5
                      description: BuscaToken
                      uri: kamelet:redis-sink
                      parameters:
                        redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                        redisPort: 6379
                        command: GET
                  - unmarshal:
                      id: unmarshal-8ce0
                      disabled: false
                      json:
                        id: json-4933
                  - setProperty:
                      id: setProperty-token-valido
                      description: "TOKEN: tokenBancario"
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-f024
                          expression: ${body[token]}
                  - setProperty:
                      id: setProperty-6c47
                      description: "TOKEN: bancoArquivoCertificado"
                      name: bancoArquivoCertificado
                      expression:
                        simple:
                          id: simple-33d0
                          expression: ${body[arquivo]}
                  - setProperty:
                      id: setProperty-1dec
                      description: "TOKEN: bancoSenhaCertificado"
                      name: bancoSenhaCertificado
                      expression:
                        simple:
                          id: simple-104f
                          expression: ${body[Senha]}
            otherwise:
              id: otherwise-78e1
              steps:
                - to:
                    id: to-bfe7
                    uri: direct
                    parameters:
                      name: busca-token-banco
                - log:
                    id: log-d6aa
                    message: "## VOLTOU PARA REDIS VALIDA TOKEN#####"
        - to:
            id: to-8cfe
            uri: direct
            parameters:
              name: route-payload-banco
        - log:
            id: log-f58b
            description: "# AQUI RECEBE O RETORNO FINAL DO BANCOS #"
            message: "# AQUI RECEBE O RETORNO FINAL DO BANCOS #"
        - convertBodyTo:
            id: convertBodyTo-string
            disabled: true
            type: java.lang.String
        - setBody:
            id: setBody-fd1e
            disabled: true
            expression:
              simple:
                id: simple-cfba
                expression: ${body}
- route:
    id: busca-dados-banco-para-token
    description: busca-dados-bancarios
    from:
      id: from-redis-valida-token2
      uri: direct
      parameters:
        name: busca-dados-bancarios
      steps:
        - log:
            id: log-89a1
            description: "# ROUTE-DADOS-BANCARIOS #"
            message: "# ROUTE-DADOS-BANCARIOS #"
        - setHeader:
            id: setHeader-9267
            name: CamelRedis.Key
            expression:
              simple:
                id: simple-260a
                expression: ${exchangeProperty.redisKey}
        - to:
            id: redis-busca-dados-banco
            description: BuscaDadosBanco
            uri: kamelet:redis-sink
            parameters:
              redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
              redisPort: 6379
              command: EXISTS
        - log:
            id: log-16c1
            message: ${body}
        - choice:
            id: choice-dadd
            disabled: false
            when:
              - id: when-e23d
                disabled: false
                expression:
                  simple:
                    id: simple-3775
                    expression: ${body} == true
                steps:
                  - to:
                      id: to-redis-busca-chaves
                      description: RedisGetDadosBanco
                      uri: kamelet:redis-sink
                      parameters:
                        redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                        redisPort: 6379
                        command: GET
                  - log:
                      id: log-62ea
                      description: "# RRECEBEU DADOS DO BANCO #"
                      message: "# RRECEBEU DADOS DO BANCO #"
                  - unmarshal:
                      id: unmarshal-busca-chaves
                      json:
                        id: json-e49b
                        library: Jackson
                  - setProperty:
                      id: setProperty-appKey
                      description: "Banco: bancoAppKey"
                      name: bancoAppKey
                      expression:
                        simple:
                          id: simple-3f62
                          expression: ${body[AppKey]}
                  - setProperty:
                      id: setProperty-ClientId
                      description: "Banco: bancoClientId"
                      name: bancoClientId
                      expression:
                        simple:
                          id: simple-d07d
                          expression: ${body[ClientID]}
                  - setProperty:
                      id: setProperty-ClientSecret
                      description: "Banco: bancoClientSecret"
                      name: bancoClientSecret
                      expression:
                        simple:
                          id: simple-e743
                          expression: ${body[ClientSecret]}
                  - setProperty:
                      id: setProperty-banco-certificado
                      description: "Banco: bancoCertificado"
                      name: bancoCertificado
                      expression:
                        simple:
                          id: simple-6994
                          expression: ${body[Certificado]}
                  - setProperty:
                      id: setProperty-banco-senhaCert
                      description: "Banco: bancoSenhaCertificado"
                      name: bancoSenhaCertificado
                      expression:
                        simple:
                          id: simple-a3c9
                          expression: ${body[Senha]}
                  - setProperty:
                      id: setProperty-banco-scopes
                      description: "Banco: bancoScopes"
                      name: bancoScopes
                      expression:
                        simple:
                          id: simple-0320
                          expression: ${body[Scopes]}
                  - setProperty:
                      id: setProperty-ae79
                      description: "Banco: bancoDadosEspecificos"
                      name: bancoDadosEspecificos
                      expression:
                        simple:
                          id: simple-ecfa
                          expression: ${body}
                  - log:
                      id: log-48c2
                      description: "# FINALIZOU VARIAVEIS DADOS BANCO #"
                      message: "# FINALIZOU VARIAVEIS DADOS BANCO #"
            otherwise:
              id: otherwise-efaf
              steps:
                - log:
                    id: log-6c3f
                    description: "# DADOS BANCO NÃO ENCONTRADO #"
                    message: "# DADOS BANCO NÃO ENCONTRADO #"
                - setHeader:
                    id: setHeader-nao-existe-banco
                    name: CamelHttpResponseCode
                    expression:
                      simple:
                        id: simple-b4d9
                        expression: "400"
                - setBody:
                    id: setBody-296e
                    expression:
                      simple:
                        id: simple-1504
                        expression: >-
                          { "erro": "Chaves do banco/Unimed não encontradas no
                          Vault",

                          "codigoBanco": ${exchangeProperty.rota[codigoBanco]}

                          }
                - stop:
                    id: stop-dados-bancarios
- route:
    id: busca-token-banco
    from:
      id: from-busca-token-banco
      uri: direct
      parameters:
        name: busca-token-banco
      steps:
        - log:
            id: log-ab81
            description: "# ROUTE-BUSCA-TOKEN-BANCO #"
            message: "# ROUTE-BUSCA-TOKEN-BANCO #"
        - choice:
            id: choice-71cc
            description: Geração de Certificado
            when:
              - id: when-62c1
                description: Existe Certificado
                expression:
                  simple:
                    id: simple-d539
                    expression: >-
                      ${exchangeProperty.bancoCertificado} != null &&
                      ${exchangeProperty.bancoCertificado.trim} != ''
                steps:
                  - log:
                      id: log-f18d
                      description: "# GERA CERTIFICADO #"
                      message: "# GERA CERTIFICADO #"
                  - setProperty:
                      id: setProperty-a5e2
                      description: "Certificado: sslBeanId"
                      name: sslBeanId
                      expression:
                        groovy:
                          id: groovy-1dd6
                          expression: >
                            import java.security.KeyStore

                            import java.io.FileInputStream

                            import java.io.FileOutputStream

                            import java.util.Base64

                            import java.io.File

                            import java.nio.file.Files

                            import java.nio.file.Paths

                            // .p12 e .pfx são o mesmo formato PKCS#12, só muda
                            a extensão. O Java/Camel espera .p12, mas o conteúdo
                            é igual ao .pfx usado no Insomnia.

                            def base64 =
                            exchange.getProperty('bancoCertificado', String)

                            def senha =
                            exchange.getProperty('bancoSenhaCertificado',
                            String)

                            println("[DEBUG] Iniciando processamento de
                            certificado")

                            println("[DEBUG] Tamanho do certificado Base64: " +
                            (base64 ? base64.length() : "null"))

                            if (base64 == null || senha == null) {
                              println("[ERROR] Certificado (base64) ou Senha ausentes")
                              throw new RuntimeException('Certificado (base64) ou Senha ausentes')
                            }

                            // Decodificar Base64 para bytes

                            def pfxBytes =
                            Base64.getDecoder().decode(base64.replaceAll("\\s",
                            ""))

                            println("[DEBUG] Certificado decodificado, tamanho:
                            " + pfxBytes.length + " bytes")

                            // Salvar em arquivo temporário para uso com o Camel

                            def id = "camel-ssl-" + exchange.getExchangeId()

                            def tempDir = System.getProperty("java.io.tmpdir")

                            println("[DEBUG] Diretório temporário: " + tempDir)

                            def path = tempDir + File.separator + id + ".p12"

                            println("[DEBUG] Caminho do arquivo temporário: " +
                            path)

                            new FileOutputStream(path).withCloseable { stream ->
                              stream.write(pfxBytes)
                            }


                            println("[DEBUG] Cria
                            exchangeProperty.bancoArquivoCertificado: " + path)

                            exchange.setProperty("bancoArquivoCertificado",
                            path)


                            println("[DEBUG] Certificado salvo em: " + path)

                            def certFile = new File(path)

                            println("[DEBUG] Arquivo existe? " +
                            certFile.exists())

                            println("[DEBUG] Tamanho do arquivo: " +
                            certFile.length() + " bytes")

                            println("[DEBUG] Permissões do arquivo: " +
                            certFile.canRead() + ", " + certFile.canWrite())

                            // Opcional: ler os primeiros bytes para garantir
                            que não está corrompido

                            def headBytes =
                            Files.readAllBytes(Paths.get(path))[0..15]

                            println("[DEBUG] Primeiros bytes do arquivo: " +
                            headBytes.collect{String.format("%02X", it)}.join("
                            "))

                            // Criar e configurar SSL Context Parameters para o
                            Camel

                            def kp = new
                            org.apache.camel.support.jsse.KeyStoreParameters()

                            kp.setResource("file:" + path)

                            kp.setType("PKCS12")

                            kp.setPassword(senha)

                            println("[DEBUG] KeyStoreParameters configurado:
                            resource=file:" + path + ", type=PKCS12,
                            password=***")

                            def km = new
                            org.apache.camel.support.jsse.KeyManagersParameters()

                            km.setKeyStore(kp)

                            km.setKeyPassword(senha)

                            println("[DEBUG] KeyManagersParameters configurado")

                            // Criar o SSLContextParameters

                            def ssl = new
                            org.apache.camel.support.jsse.SSLContextParameters()

                            ssl.setKeyManagers(km)

                            println("[DEBUG] SSLContextParameters criado")

                            // Registrar o SSL Context no registro do Camel

                            exchange.getContext().getRegistry().bind(id, ssl)

                            println("[DEBUG] SSL Context configurado e
                            registrado com ID: " + id)

                            return id
                  - setProperty:
                      id: setProperty-346d
                      description: securityContext
                      name: securityContext
                      expression:
                        simple:
                          id: simple-4d2a
                          expression: ${exchangeProperty.sslBeanId}
                  - log:
                      id: log-5bcb
                      description: "# ARQ. CERT. GERADO PELO GROOVY #"
                      message: "# ARQ. CERT. GERADO PELO GROOVY #"
            otherwise:
              id: otherwise-1b5b
              steps:
                - setProperty:
                    id: setProperty-bbf4
                    description: securityContext
                    disabled: true
                    name: securityContext
                    expression:
                      simple:
                        id: simple-ced4
                        expression: "\"\""
        - setHeader:
            id: setHeader-8770
            description: "Header: Content-Type"
            name: Content-Type
            expression:
              simple:
                id: simple-5ce1
                expression: application/x-www-form-urlencoded
        - log:
            id: log-f2fa
            description: "# VALIDA BANCO PARA AUTH2 #"
            message: "# VALIDA BANCO PARA AUTH2 #"
        - choice:
            id: choice-auth2-identifica-banco
            when:
              - id: when-auth2-bb
                description: Banco == 1
                expression:
                  simple:
                    id: simple-a0b6
                    expression: ${exchangeProperty.rota[codigoBanco]} == 1
                steps:
                  - setBody:
                      id: setBody-auth2-bb-scopes
                      expression:
                        simple:
                          id: simple-8bb0
                          expression: >-
                            grant_type=client_credentials&scopes:
                            ${exchangeProperty[bancoScopes]}
                  - setHeader:
                      id: setHeader-7a86
                      description: "Header: Authorization"
                      name: Authorization
                      expression:
                        simple:
                          id: simple-e6a0
                          expression: Basic ${exchangeProperty.bancoClientSecret}
                  - setProperty:
                      id: setProperty-d5ea
                      description: bancoOAuthUrl
                      name: bancoOAuthUrl
                      expression:
                        simple:
                          id: simple-5a09
                          expression: ${exchangeProperty.bancoDadosEspecificos[url_oauth]}
                  - toD:
                      id: to-req-oauth2-bb
                      disabled: true
                      uri: https
                      parameters:
                        httpUri: oauth.hm.bb.com.br/oauth/token
                        httpMethod: POST
                        bridgeEndpoint: true
                        logHttpActivity: false
                  - unmarshal:
                      id: unmarshal-recebe-token
                      disabled: true
                      json:
                        id: json-07e8
                  - setProperty:
                      id: setProperty-2a48
                      description: "Variavel: tokenBancario"
                      disabled: true
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-0098
                          expression: ${body[access_token]}
              - id: when-a865
                description: Banco == 33
                expression:
                  simple:
                    id: simple-c13b
                    expression: ${exchangeProperty.rota[codigoBanco]} == 33
                steps:
                  - setBody:
                      id: setBody-2d3d
                      expression:
                        simple:
                          id: simple-a586
                          expression: >-
                            grant_type=client_credentials&client_secret=${exchangeProperty[bancoClientSecret]}&client_id=${exchangeProperty[bancoClientId]}
                  - setHeader:
                      id: setHeader-santander-ssl-certificate
                      description: "Host: Santander"
                      name: Host
                      expression:
                        simple:
                          id: simple-santander-certificate
                          expression: trust-sandbox.api.santander.com.br
                  - setProperty:
                      id: setProperty-237e
                      description: bancoOAuthUrl
                      name: bancoOAuthUrl
                      expression:
                        simple:
                          id: simple-dec0
                          expression: ${exchangeProperty.bancoDadosEspecificos[url_oauth]}
                  - toD:
                      id: to-c3f7
                      disabled: true
                      uri: >-
                        https://trust-sandbox.api.santander.com.br/auth/oauth/v2/token
                      parameters:
                        httpMethod: POST
                        bridgeEndpoint: true
                        logHttpActivity: false
                        sslContextParameters: "#${exchangeProperty.sslBeanId}"
                        httpUri: >-
                          trust-sandbox.api.santander.com.br/auth/oauth/v2/token?disableContentCompression=false
                  - unmarshal:
                      id: unmarshal-b606
                      disabled: true
                      json:
                        id: json-a967
                  - setProperty:
                      id: setProperty-santander-token
                      description: "Variavel: tokenBancario"
                      disabled: true
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-santander-token
                          expression: ${body[access_token]}
              - id: when-334f
                description: Banco == 341
                expression:
                  simple:
                    id: simple-3f18
                    expression: ${exchangeProperty.rota[codigoBanco]} == 341
                steps:
                  - setBody:
                      id: setBody-a928
                      expression:
                        simple:
                          id: simple-2942
                          expression: >-
                            grant_type=client_credentials&client_secret=${exchangeProperty[bancoClientSecret]}&client_id=${exchangeProperty[bancoClientId]}
                  - setProperty:
                      id: setProperty-7fde
                      description: bancoOAuthUrl
                      name: bancoOAuthUrl
                      expression:
                        simple:
                          id: simple-d711
                          expression: ${exchangeProperty.bancoDadosEspecificos[url_oauth]}
                  - toD:
                      id: to-8221
                      disabled: true
                      uri: https
                      parameters:
                        httpUri: sandbox.devportal.itau.com.br/api/oauth/jwt
                        bridgeEndpoint: true
                        httpMethod: POST
                        logHttpActivity: false
                  - unmarshal:
                      id: unmarshal-5ae8
                      disabled: true
                      json:
                        id: json-c585
                  - setProperty:
                      id: setProperty-f268
                      description: "Variavel: tokenBancario"
                      disabled: true
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-721a
                          expression: ${body[access_token]}
              - id: when-cd7b
                description: Banco == 748
                expression:
                  simple:
                    id: simple-6c66
                    expression: ${exchangeProperty.rota[codigoBanco]} == 748
                steps:
                  - setBody:
                      id: setBody-c6cc
                      expression:
                        simple:
                          id: simple-28a3
                          expression: >-
                            username=${exchangeProperty.bancoDadosEspecificos[username]}&password=${exchangeProperty.bancoDadosEspecificos[password]}&grant_type=${exchangeProperty.bancoDadosEspecificos[grant_type]}&scope=${exchangeProperty.bancoScopes}
                  - setHeaders:
                      id: setHeaders-3a3a
                      headers:
                        - id: setHeader-1a84
                          name: x-api-key
                          expression:
                            simple:
                              id: simple-b699
                              expression: ${exchangeProperty.bancoClientId}
                        - id: setHeader-f63c
                          name: context
                          expression:
                            simple:
                              id: simple-24c6
                              expression: COBRANCA
                  - setProperty:
                      id: setProperty-0b29
                      description: bancoOAuthUrl
                      name: bancoOAuthUrl
                      expression:
                        simple:
                          id: simple-eb50
                          expression: ${exchangeProperty.bancoDadosEspecificos[url_oauth]}
                  - toD:
                      id: to-726c
                      disabled: true
                      uri: https
                      parameters:
                        httpUri: api-parceiro.sicredi.com.br/sb/auth/openapi/token
                        bridgeEndpoint: true
                        httpMethod: POST
                        logHttpActivity: false
                  - unmarshal:
                      id: unmarshal-a880
                      disabled: true
                      json:
                        id: json-0752
              - id: when-ef06
                description: Banco == 136
                expression:
                  simple:
                    id: simple-5985
                    expression: ${exchangeProperty.rota[codigoBanco]} == 136
                steps:
                  - setBody:
                      id: setBody-f021
                      expression:
                        simple:
                          id: simple-af2e
                          expression: >-
                            nomeUsuario=${exchangeProperty.bancoDadosEspecificos[nomeUsuario]}&senha=${exchangeProperty.bancoDadosEspecificos[senha]}
                  - log:
                      id: log-3cb9
                      message: ${body}
                  - setHeader:
                      id: setHeader-7082
                      name: apiKey
                      expression:
                        simple:
                          id: simple-7af5
                          expression: ${exchangeProperty.bancoApiKey}
                  - setProperty:
                      id: setProperty-badb
                      description: bancoOAuthUrl
                      name: bancoOAuthUrl
                      expression:
                        simple:
                          id: simple-7a04
                          expression: ${exchangeProperty.bancoDadosEspecificos[url_oauth]}
                  - toD:
                      id: to-81ca
                      disabled: true
                      uri: https
                      parameters:
                        httpUri: ${exchangeProperty.bancoOAuthUrl}
                        bridgeEndpoint: true
                        httpMethod: POST
            otherwise:
              id: otherwise-auth2-identifica-banco
              steps:
                - setHeader:
                    id: setHeader-1851
                    name: CamelHttpResponseCode
                    expression:
                      simple:
                        id: simple-26ed
                        expression: "400"
                - setBody:
                    id: setBody-5135
                    expression:
                      simple:
                        id: simple-ed61
                        expression: >-
                          { erro: "Banco não idetificado para busca do token
                          oAuth2",

                          "codigoBanco": ${exchangeProperty.rota[codigoBanco]}

                          }
                - stop:
                    id: stop-d54d
        - doTry:
            id: doTry-e0c4
            doCatch:
              - id: doCatch-d0a0
                exception:
                  - java.lang.Exception
                steps:
                  - setBody:
                      id: setBody-36aa
                      expression:
                        simple:
                          id: simple-498b
                          expression: ${exception.getResponseBody()}
                  - stop:
                      id: stop-cebc
            steps:
              - choice:
                  id: choice-5587
                  when:
                    - id: when-6491
                      description: securityContext != ""
                      expression:
                        simple:
                          id: simple-cd38
                          expression: >-
                            ${exchangeProperty.securityContext} != null &&
                            ${exchangeProperty.securityContext.trim} != ''
                      steps:
                        - log:
                            id: log-4fa5
                            description: "# AUTH COM CERT #"
                            message: "# AUTH COM CERT #"
                        - toD:
                            id: to-efb5
                            uri: https
                            parameters:
                              httpUri: >-
                                trust-sandbox.api.santander.com.br/auth/oauth/v2/token?disableContentCompression=false
                              bridgeEndpoint: true
                              httpMethod: POST
                              sslContextParameters: "#${exchangeProperty.sslBeanId}"
                  otherwise:
                    id: otherwise-e094
                    steps:
                      - log:
                          id: log-badf
                          description: "# AUTH SEM CERT #"
                          message: "# AUTH SEM CERT #"
                      - toD:
                          id: to-2051
                          uri: https
                          parameters:
                            httpUri: ${exchangeProperty.bancoOAuthUrl}
                            bridgeEndpoint: true
                            httpMethod: POST
              - log:
                  id: log-6720
                  description: "# TOKEN RECEBIDO #"
                  message: "# TOKEN RECEBIDO #"
        - unmarshal:
            id: unmarshal-bb71
            json:
              id: json-5bc3
        - log:
            id: log-0097
            description: "# COMU. OAUTH2 FINALIZADA #"
            message: "# COMU. OAUTH2 FINALIZADA #"
        - setProperty:
            id: setProperty-aed8
            description: "Variavel: tokenBancario"
            name: tokenBancario
            expression:
              simple:
                id: simple-c618
                expression: ${body[access_token]}
        - choice:
            id: choice-valida-recebeu-token
            disabled: false
            when:
              - id: when-e5fc
                description: RecebeuToken
                expression:
                  simple:
                    id: simple-9e45
                    expression: ${exchangeProperty.tokenBancario} != ""
                steps:
                  - log:
                      id: log-afe0
                      description: "# TOKEN RECEBIDO #"
                      message: "# TOKEN RECEBIDO #"
                  - setHeader:
                      id: setHeader-e778
                      name: CamelRedis.Key
                      expression:
                        simple:
                          id: simple-63a6
                          expression: ${exchangeProperty.redisToken}
                  - setHeader:
                      id: setHeader-6e15
                      name: CamelRedis.Timeout
                      expression:
                        simple:
                          id: simple-934c
                          expression: ${body[expires_in]}
                  - setBody:
                      id: setBody-1cd4
                      disabled: false
                      expression:
                        simple:
                          id: simple-ecb2
                          expression: >-
                            {"Senha":"${exchangeProperty.bancoSenhaCertificado}","token":"${exchangeProperty.tokenBancario}","arquivo":"${exchangeProperty.bancoArquivoCertificado}"}
                  - to:
                      id: to-redis-set-token
                      description: CriaToken
                      uri: kamelet:redis-sink
                      parameters:
                        redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                        redisPort: 6379
                        command: SETEX
                  - log:
                      id: log-4a23
                      description: "# TOKEN SALVO NO REDIS #"
                      message: "# TOKEN SALVO NO REDIS #"
            otherwise:
              id: otherwise-5ab6
              steps:
                - setBody:
                    id: setBody-retorno-erro-banco-token
                    expression:
                      simple:
                        id: simple-c0be
                        expression: ${body}
                - stop:
                    id: stop-678a
- route:
    id: route-payload-banco
    nodePrefixId: route-payload-banco
    from:
      id: from-redis-valida-token
      uri: direct
      parameters:
        name: route-payload-banco
      steps:
        - log:
            id: log-05db
            description: "# ROUTE-PAYLOAD-BANCO #"
            message: "# ROUTE-PAYLOAD-BANCO #"
        - setBody:
            id: setBody-96ff
            expression:
              simple:
                id: simple-b02e
                expression: ${exchangeProperty.dadosRecebidos}
        - bean:
            id: bean-4a67
            ref: montaPayload
            method: montarPayload
        - setProperty:
            id: setProperty-c7d8
            description: "Body: payloadEnvio"
            name: payloadEnvio
            expression:
              simple:
                id: simple-a9b2
                expression: ${body}
        - choice:
            id: choice-0fe2
            when:
              - id: when-a85f
                description: bancoArquivoCertificado!= ""
                expression:
                  simple:
                    id: simple-a692
                    expression: >-
                      ${exchangeProperty.bancoCertificado != null &&
                      exchangeProperty.bancoArquivoCertificado != ""}
                steps:
                  - log:
                      id: log-4635
                      description: "# BUSCA ARQ CERT. GROOVY #"
                      message: >-
                        # BUSCA ARQ CERT. GROOVY:
                        ${exchangeProperty.tokenArquivoCertificado}
                  - setProperty:
                      id: setProperty-c337
                      description: "SSL: Add certificado"
                      disabled: false
                      name: sslBeanId
                      expression:
                        groovy:
                          id: groovy-1cc6
                          expression: >
                            import java.io.File

                            import java.nio.file.Files

                            import java.nio.file.Paths

                            // Recebe o nome do arquivo do certificado já
                            existente

                            // e a senha em bancoSenhaCertificado


                            def arquivo =
                            exchange.getProperty('bancoArquivoCertificado',
                            String) // agora é o nome do arquivo


                            def senha =
                            exchange.getProperty('bancoSenhaCertificado',
                            String)


                            println("[DEBUG] Iniciando processamento de
                            certificado por nome de arquivo")

                            println("[DEBUG] Nome do arquivo recebido: " +
                            arquivo)

                            println("[DEBUG] Senha recebida: " + (senha ? "***"
                            : "null"))


                            if (arquivo == null || senha == null) {
                              println("[ERROR] Nome do arquivo ou senha ausentes")
                              throw new RuntimeException('Nome do arquivo ou senha ausentes')
                            }


                            def certFile = new File(arquivo)

                            if (!certFile.exists()) {
                              println("[ERROR] Arquivo de certificado não encontrado: " + arquivo)
                              throw new RuntimeException('Arquivo de certificado não encontrado: ' + arquivo)
                            }

                            println("[DEBUG] Arquivo existe? " +
                            certFile.exists())

                            println("[DEBUG] Tamanho do arquivo: " +
                            certFile.length() + " bytes")

                            println("[DEBUG] Permissões do arquivo: " +
                            certFile.canRead() + ", " + certFile.canWrite())

                            // Opcional: ler os primeiros bytes para garantir
                            que não está corrompido

                            def headBytes =
                            Files.readAllBytes(Paths.get(arquivo))[0..15]

                            println("[DEBUG] Primeiros bytes do arquivo: " +
                            headBytes.collect{String.format("%02X", it)}.join("
                            "))

                            // Criar e configurar SSL Context Parameters para o
                            Camel

                            def kp = new
                            org.apache.camel.support.jsse.KeyStoreParameters()

                            kp.setResource("file:" + arquivo)

                            kp.setType("PKCS12")

                            kp.setPassword(senha)

                            println("[DEBUG] KeyStoreParameters configurado:
                            resource=file:" + arquivo + ", type=PKCS12,
                            password=***")

                            def km = new
                            org.apache.camel.support.jsse.KeyManagersParameters()

                            km.setKeyStore(kp)

                            km.setKeyPassword(senha)

                            println("[DEBUG] KeyManagersParameters configurado")

                            def ssl = new
                            org.apache.camel.support.jsse.SSLContextParameters()

                            ssl.setKeyManagers(km)

                            println("[DEBUG] SSLContextParameters criado")

                            exchange.getContext().getRegistry().bind("camel-ssl-"
                            + exchange.getExchangeId(), ssl)

                            println("[DEBUG] SSL Context configurado e
                            registrado com ID: camel-ssl-" +
                            exchange.getExchangeId())

                            return "camel-ssl-" + exchange.getExchangeId()
            otherwise:
              id: otherwise-c99e
        - choice:
            id: choice-ec60
            when:
              - id: when-b0f4
                description: Banco == 1
                expression:
                  simple:
                    id: simple-8b31
                    expression: ${exchangeProperty.rota[codigoBanco]} == 1
                steps:
                  - to:
                      id: to-1155
                      uri: direct
                      parameters:
                        name: bb-cobranca
              - id: when-1254
                description: Banco == 33
                expression:
                  simple:
                    id: simple-a57d
                    expression: ${exchangeProperty.rota[codigoBanco]} == 33
                steps:
                  - to:
                      id: to-8e67
                      uri: direct
                      parameters:
                        name: santander-cobranca
              - id: when-dd24
                description: Banco == 341
                expression:
                  simple:
                    id: simple-8a5c
                    expression: ${exchangeProperty.rota[codigoBanco]} == 341
                steps:
                  - to:
                      id: to-5036
                      uri: direct
                      parameters:
                        name: itau-cobranca
              - id: when-579f
                description: Banco == 748
                expression:
                  simple:
                    id: simple-4d54
                    expression: ${exchangeProperty.rota[codigoBanco]} == 748
                steps:
                  - to:
                      id: to-acce
                      uri: direct
                      parameters:
                        name: sicredi-cobranca
            otherwise:
              id: otherwise-cb94
- route:
    id: bb-cobranca
    nodePrefixId: route-ecf
    from:
      id: from-bb-cobranca
      uri: direct
      parameters:
        name: bb-cobranca
      steps:
        - log:
            id: log-4a6b
            description: "# ROUTE-BB-COBRANCA #"
            message: "# ROUTE-BB-COBRANCA #"
        - setHeader:
            id: setHeader-content-type-bb-cobranca
            name: Content-Type
            expression:
              constant:
                id: constant-content-type-bb-cobranca
                expression: application/json
        - doTry:
            id: doTry-bb-cobranca
            doCatch:
              - id: doCatch-bb-cobranca
                exception:
                  - java.lang.Exception
                steps:
                  - setHeader:
                      id: setHeader-http-status
                      name: CamelHttpResponseCode
                      expression:
                        simple:
                          id: simple-http-status
                          expression: ${header.CamelHttpResponseCode}
                  - setBody:
                      id: setBody-erro
                      expression:
                        simple:
                          id: simple-erro
                          expression: ${exception.getResponseBody()}
                  - stop:
                      id: stop-erro
            steps:
              - setHeader:
                  id: setHeader-authorization-BB
                  name: Authorization
                  expression:
                    simple:
                      id: simple-authorization
                      expression: Bearer ${exchangeProperty.tokenBancario}
              - setHeader:
                  id: setHeader-gwkey
                  disabled: false
                  name: X-Developer-Application-Key
                  expression:
                    simple:
                      id: simple-gwkey
                      expression: ${exchangeProperty.bancoAppKey}
              - log:
                  id: log-c7e4
                  description: "## APPKEY BB ##"
                  message: ${exchangeProperty.bancoAppKey}
              - choice:
                  id: choice-rota-saida
                  when:
                    - id: envio-bb-inclusao
                      expression:
                        simple:
                          id: simple-envio-bb-inclusao
                          expression: ${exchangeProperty.rota[tipo]} == "registrar"
                      steps:
                        - log:
                            id: log-aefa
                            description: "# BB-REGISTRO-BOLETO #"
                            message: "# BB-REGISTRO-BOLETO #"
                        - toD:
                            id: toD-bb-cobranca
                            uri: https://api.hm.bb.com.br/cobrancas/v2/boletos
                            parameters:
                              httpMethod: POST
                              logHttpActivity: true
                              bridgeEndpoint: true
                              httpUri: https://api.hm.bb.com.br/cobrancas/v2/boletos
                        - setBody:
                            id: setBody-bb-aceito
                            disabled: true
                            expression:
                              simple:
                                id: simple-bb-aceito
                                expression: ${body}
                        - log:
                            id: log-response-success-inclusao
                            description: "## RESPOSTA BB ###"
                            disabled: true
                            message: "Resposta BB: ${body}"
                            loggingLevel: INFO
                            logName: bb-cobranca
                    - id: envio-bb-alteracao
                      expression:
                        simple:
                          id: simple-envio-bb-alteracao
                          expression: ${exchangeProperty.rota[tipo]} != "registrar"
                      steps:
                        - toD:
                            id: toD-bb-cobranca-alteracao
                            uri: >-
                              https://api.hm.bb.com.br/cobrancas/v2/boletos/${exchangeProperty.dadosBoleto[numeroNossoNumero]}
                            parameters:
                              gwDevAppKey: ${exchangeProperty.appKey}
                              httpMethod: PATCH
                              logHttpActivity: false
                              bridgeEndpoint: false
                        - setBody:
                            id: setBody-bb-alteracao
                            disabled: true
                            expression:
                              simple:
                                id: simple-bb-alteracao
                                expression: ${body}
                        - log:
                            id: log-response-success-alteracao
                            description: "## RESPOSTA BB ###"
                            disabled: true
                            message: "Resposta BB: ${body}"
                            loggingLevel: INFO
                            logName: bb-cobranca
                  otherwise:
                    id: otherwise-bb-operacao-desconhecida
                    steps:
                      - setHeader:
                          id: setHeader-bb-erro
                          name: CamelHttpResponseCode
                          expression:
                            simple:
                              id: simple-status-erro-bb
                              expression: "400"
                      - setBody:
                          id: setBody-bb-erro
                          expression:
                            simple:
                              id: simple-erro-operacao
                              expression: |
                                {
                                  "mensagem": "Operação não suportada: ${exchangeProperty.rota[tipo]}"
                                }
- route:
    id: santander-cobranca
    nodePrefixId: route-ecf
    from:
      id: from-santander-cobranca
      uri: direct
      parameters:
        name: santander-cobranca
      steps:
        - log:
            id: log-4eef
            description: "# ROUTE-SANTANDER-COBRANCA #"
            message: "# ROUTE-SANTANDER-COBRANCA #"
        - doTry:
            id: doTry-ee75
            doCatch:
              - id: doCatch-d714
                exception:
                  - java.lang.Exception
                steps:
                  - log:
                      id: log-9cc1
                      message: "### ERRO AO BUSCaR WORKSPACE ###"
                  - stop:
                      id: stop-6a65
            steps:
              - log:
                  id: log-14bd
                  description: "# SANT. BUSCA WORKSPACE #"
                  message: "# SANT. BUSCA WORKSPACE #"
              - setHeader:
                  id: setHeader-5e38
                  name: CamelRedis.Key
                  expression:
                    simple:
                      id: simple-d45d
                      expression: ${exchangeProperty.redisKey}
              - toD:
                  id: to-0953
                  uri: kamelet:redis-sink
                  parameters:
                    redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                    redisPort: 6379
                    command: GET
              - unmarshal:
                  id: unmarshal-21e9
                  json:
                    id: json-cec0
              - setProperty:
                  id: setProperty-5b32
                  description: "Var: santanderWorkspace"
                  name: santanderWorkspace
                  expression:
                    simple:
                      id: simple-541f
                      expression: ${body[Workspace]}
              - setProperty:
                  id: setProperty-bdc8
                  description: URL
                  name: santanderURL
                  expression:
                    simple:
                      id: simple-0e37
                      expression: >-
                        trust-sandbox.api.santander.com.br/collection_bill_management/v2/workspaces/${exchangeProperty[santanderWorkspace]}/bank_slips
        - log:
            id: log-018e
            description: "# ENVIO AO SANTANDER #"
            message: "# ENVIO AO SANTANDER #"
        - setHeaders:
            id: setHeaders-90f8
            headers:
              - id: setHeader-ba73
                name: X-Application-Key
                expression:
                  simple:
                    id: simple-847a
                    expression: ${exchangeProperty.bancoClientId}
              - id: setHeader-bcfe
                name: Authorization
                expression:
                  simple:
                    id: simple-674c
                    expression: Bearer ${exchangeProperty[tokenBancario]}
        - setBody:
            id: setBody-6cf5
            disabled: false
            expression:
              simple:
                id: simple-1919
                expression: ${exchangeProperty[payloadEnvio]}
        - doTry:
            id: doTry-251b
            doCatch:
              - id: doCatch-bead
                exception:
                  - java.lang.Exception
                steps:
                  - setBody:
                      id: setBody-acdb
                      expression:
                        simple:
                          id: simple-6c63
                          expression: ${exception.getResponseBody()}
            steps:
              - toD:
                  id: to-69a2
                  uri: https
                  parameters:
                    bridgeEndpoint: true
                    httpMethod: POST
                    logHttpActivity: false
                    httpUri: ${exchangeProperty[santanderURL]}
                    sslContextParameters: "#${exchangeProperty.sslBeanId}"
- route:
    id: itau-cobranca
    nodePrefixId: route-ecf
    from:
      id: from-itau-cobranca
      uri: direct
      parameters:
        name: itau-cobranca
        synchronous: false
      steps:
        - log:
            id: log-76e2
            description: "# ROUTE ITAU COBRANCA #"
            message: "# ROUTE ITAU COBRANCA #"
        - setHeader:
            id: setHeader-a335
            disabled: false
            name: x-itau-apikey
            expression:
              simple:
                id: simple-544c
                expression: ${exchangeProperty.bancoClientId}
        - setHeader:
            id: setHeader-1a16
            disabled: false
            name: x-itau-correlationID
            expression:
              simple:
                id: simple-c2a2
                expression: ${exchangeProperty.bancoClientSecret}
        - setHeader:
            id: setHeader-8b9c
            disabled: false
            name: Authorization
            expression:
              simple:
                id: simple-68ae
                expression: ${exchangeProperty.tokenBancario}
        - setBody:
            id: setBody-e800
            expression:
              simple:
                id: simple-27ef
                expression: |-
                  {
                    etapa_processo_boleto: 'efetivacao',
                    beneficiario: {
                      id_beneficiario: '150000052061'
                    },
                    dado_boleto: {
                      tipo_boleto: 'a vista',
                      descricao_instrumento_cobranca: 'boleto_pix',
                      texto_seu_numero: '000001',
                      codigo_carteira: '110',
                      valor_total_titulo: '90000000000030000',
                      codigo_especie: '01',
                      data_emissao: '2022-03-25',
                      valor_abatimento: '00000000000000010',
                      negativacao: {
                        negativacao: '8',
                        quantidade_dias_negativacao: '010'
                      },
                      pagador: {
                        pessoa: {
                          nome_pessoa: 'Joao Silva',
                          nome_fantasia: 'Joao Silva',
                          tipo_pessoa: {
                            codigo_tipo_pessoa: 'F',
                            numero_cadastro_pessoa_fisica: '26556923221'
                          }
                        },
                        endereco: {
                          nome_logradouro: 'Av do Estado, 5533',
                          nome_bairro: 'Mooca',
                          nome_cidade: 'Sao Paulo',
                          sigla_UF: 'SP',
                          numero_CEP: '04135010'
                        }
                      },
                      sacador_avalista: {
                        pessoa: {
                          nome_pessoa: 'Sacador Teste',
                          tipo_pessoa: {
                            codigo_tipo_pessoa: 'F',
                            numero_cadastro_pessoa_fisica: '38365972841'
                          }
                        },
                        endereco: {
                          nome_logradouro: 'Av do Estado, 5533',
                          nome_bairro: 'Mooca',
                          nome_cidade: 'Sao Paulo',
                          sigla_UF: 'SP',
                          numero_CEP: '04135010'
                        }
                      },
                      dados_individuais_boleto: [
                        {
                          numero_nosso_numero: '12345678',
                          data_vencimento: '2022-07-30',
                          texto_uso_beneficiario: '000001',
                          valor_titulo: '00000000000010001',
                          data_limite_pagamento: '2022-10-30'
                        }
                      ],
                      juros: {
                        data_juros: '2022-09-30',
                        codigo_tipo_juros: '93',
                        valor_juros: '00000000000000010'
                      },
                      multa: {
                        codigo_tipo_multa: '02',
                        percentual_multa: '000000100001',
                        data_multa: '2022-10-30'
                      },
                      lista_mensagem_cobranca: [
                        {
                          mensagem: 'mensagem 1'
                        }
                      ],
                      desconto: {
                        codigo_tipo_desconto: '02',
                        descontos: [
                          {
                            data_desconto: '2022-06-30',
                            valor_desconto: '00000000000010000',
                            percentual_desconto: '000000001010'
                          }
                        ]
                      }
                    },
                    dados_qrcode: {
                      chave: 'pjoperador@gmail.com',
                      id_location: 789
                    }
                  }
        - doTry:
            id: doTry-644e
            doCatch:
              - id: doCatch-9531
                exception:
                  - java.lang.Exception
                steps:
                  - setBody:
                      id: setBody-5f8c
                      expression:
                        simple:
                          id: simple-9b0b
                          expression: ${exception.getResponseBody()}
            steps:
              - toD:
                  id: to-46fd
                  uri: https
                  parameters:
                    httpUri: >-
                      sandbox.devportal.itau.com.br/itau-ep9-gtw-pix-recebimentos-conciliacoes-v2-ext/v2/boletos_pix
                    httpMethod: POST
                    bridgeEndpoint: true
                    logHttpActivity: false
- route:
    id: sicredi-cobranca
    nodePrefixId: route-ecf
    from:
      id: from-sicredi-cobranca
      uri: direct
      parameters:
        name: sicredi-cobranca
      steps:
        - log:
            id: log-8ca5
            description: "# ROUTE SICREDI COBRANCA #"
            message: "# ROUTE SICREDI COBRANCA #"
        - setHeaders:
            id: setHeaders-abe7
            headers:
              - id: setHeader-x-api-key
                name: x-api-key
                expression:
                  simple:
                    id: simple-fdf4
                    expression: ${exchangeProperty.bancoClientId}
              - id: setHeader-cooperativa
                name: cooperativa
                expression:
                  simple:
                    id: simple-38cb
                    expression: ${exchangeProperty.bancoDadosEspecificos[cooperativa]}
              - id: setHeader-posto
                name: posto
                expression:
                  simple:
                    id: simple-3188
                    expression: ${exchangeProperty.bancoDadosEspecificos[posto]}
              - id: setHeader-authorization
                name: Authorization
                expression:
                  simple:
                    id: simple-e6ac
                    expression: Bearer ${exchangeProperty.tokenBancario}
        - setBody:
            id: setBody-be6b
            expression:
              simple:
                id: simple-a7e6
                expression: ${exchangeProperty[payloadEnvio]}
        - doTry:
            id: doTry-225c
            doCatch:
              - id: doCatch-4c66
                exception:
                  - java.lang.Exception
                steps:
                  - setBody:
                      id: setBody-ab12
                      expression:
                        simple:
                          id: simple-9577
                          expression: ${exception.getResponseBody()}
            steps:
              - toD:
                  id: to-5df9
                  uri: https
                  parameters:
                    httpUri: api-parceiro.sicredi.com.br/sb/cobranca/boleto/v1/boletos
                    bridgeEndpoint: true
                    httpMethod: POST
                    logHttpActivity: false
