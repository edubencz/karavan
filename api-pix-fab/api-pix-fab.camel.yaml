- rest:
    id: rest-api-pix
    post:
      - id: post-api-pix
        path: /teste
        to: direct:validar-payload
        consumes: application/json
        produces: application/json
- route:
    id: route-recebe-requisicao
    nodePrefixId: route-recebe-requisicao
    from:
      id: from-api-pix
      uri: direct
      parameters:
        name: validar-payload
      steps:
        - doTry:
            id: doTry-valida-payload
            doCatch:
              - id: doCatch-valida-payload
                exception:
                  - java.lang.Exception
                steps:
                  - convertBodyTo:
                      id: convertBodyTo-exception-string
                      type: java.lang.String
                  - setHeader:
                      id: setHeader-ca85
                      name: CamelHttpResponseCode
                      expression:
                        simple:
                          id: simple-status-400
                          expression: "400"
                  - setHeader:
                      id: setHeader-exception-content
                      name: Content-Type
                      expression:
                        constant:
                          id: constant-content-json
                          expression: application/json
                  - setBody:
                      id: setBody-exception-message
                      expression:
                        simple:
                          id: simple-exception-message
                          expression: >-
                            { "mensagem": "Erro no payload:
                            ${exception.message.replaceAll('\r?\n', ' ')}" }
                  - stop:
                      id: stop-on-exception
            steps:
              - to:
                  id: to-json-validator-schema
                  uri: json-validator
                  parameters:
                    resourceUri: file:nexdom-schema.json
              - unmarshal:
                  id: unmarshal-json
                  json:
                    id: json-unmarshal
              - setProperty:
                  id: setProperty-15ee
                  description: dadosRecebidos
                  name: dadosRecebidos
                  expression:
                    simple:
                      id: simple-5831
                      expression: ${body}
              - setProperty:
                  id: setProperty-rota
                  description: "Variavel: rota"
                  name: rota
                  expression:
                    simple:
                      id: simple-extract-rota
                      expression: ${body[rota]}
              - setProperty:
                  id: setProperty-redis-banco-key
                  description: "Variavel: redisKey"
                  name: redisKey
                  expression:
                    simple:
                      id: simple-176c
                      expression: >-
                        apipix:${exchangeProperty.rota[codigoUnimed]}:${exchangeProperty.rota[codigoBanco]}
              - setProperty:
                  id: setProperty-ffe9
                  description: "Variavel: redisToken"
                  name: redisToken
                  expression:
                    simple:
                      id: simple-d8fd
                      expression: ${exchangeProperty.redisKey}:token
              - marshal:
                  id: marshal-payload-json
                  json:
                    id: json-marshal
              - to:
                  id: to-validate-banco
                  uri: direct
                  parameters:
                    name: redis-valida-token
- route:
    id: redis-valida-token
    nodePrefixId: route-redis-valida
    from:
      id: from-route-recebe-requisicao
      uri: direct
      parameters:
        name: redis-valida-token
      steps:
        - log:
            id: log-28c0
            message: "#####ROUTE REDIS-VALIDA-TOKEN#####"
        - setHeader:
            id: setHeader-redis-token-key
            name: CamelRedis.Key
            expression:
              simple:
                id: simple-3c0f
                expression: ${exchangeProperty.redisToken}
        - to:
            id: to-480b
            description: ExisteToken
            uri: kamelet:redis-sink
            parameters:
              redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
              redisPort: 6379
              command: EXISTS
        - log:
            id: log-resultado-redis
            message: ${body}
        - choice:
            id: choice-redis-existe-token
            description: Choice:ExisteToken
            when:
              - id: when-a54b
                expression:
                  simple:
                    id: simple-97dd
                    expression: ${body} == true
                steps:
                  - to:
                      id: to-95c5
                      description: BuscaToken
                      uri: kamelet:redis-sink
                      parameters:
                        redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                        redisPort: 6379
                        command: GET
                  - log:
                      id: log-523b
                      message: TOKEN BANCO> ${body}
                  - setProperty:
                      id: setProperty-token-valido
                      description: "TOKEN: tokenBancario"
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-f024
                          expression: ${body}
                  - log:
                      id: log-4be1
                      message: "TOKKKEN: ${exchangeProperty.tokenBancario}"
            otherwise:
              id: otherwise-78e1
              steps:
                - to:
                    id: to-redis-gera-oauth2-token
                    uri: direct
                    parameters:
                      name: redis-gera-oauth2-token
                - log:
                    id: log-d6aa
                    message: "## VOLTOU PARA REDIS VALIDA TOKEN#####"
        - to:
            id: to-8cfe
            uri: direct
            parameters:
              name: valida-banco
        - log:
            id: log-f58b
            description: "LOG: FIM DO PROCESSO"
            message: ${body}
        - convertBodyTo:
            id: convertBodyTo-string
            type: java.lang.String
        - setBody:
            id: setBody-fd1e
            expression:
              simple:
                id: simple-cfba
                expression: ${body}
- route:
    id: redis-gera-oauth2-token
    from:
      id: from-redis-valida-token
      uri: direct
      parameters:
        name: redis-gera-oauth2-token
      steps:
        - log:
            id: log-89a1
            message: "####ROUTE-GERA-OAUTH2-TOKEN######"
        - setHeader:
            id: setHeader-9267
            name: CamelRedis.Key
            expression:
              simple:
                id: simple-260a
                expression: ${exchangeProperty.redisKey}
        - to:
            id: redis-busca-dados-banco
            description: BuscaDadosBanco
            uri: kamelet:redis-sink
            parameters:
              redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
              redisPort: 6379
              command: EXISTS
        - log:
            id: log-16c1
            message: ${body}
        - choice:
            id: choice-dadd
            disabled: false
            when:
              - id: when-e23d
                disabled: false
                expression:
                  simple:
                    id: simple-3775
                    expression: ${body} == true
                steps:
                  - to:
                      id: to-redis-busca-chaves
                      description: RedisGetDadosBanco
                      uri: kamelet:redis-sink
                      parameters:
                        redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                        redisPort: 6379
                        command: GET
                  - log:
                      id: log-62ea
                      message: "### RETORNO COM DADOS DO BANCO PARA TOKEN####"
                  - unmarshal:
                      id: unmarshal-busca-chaves
                      json:
                        id: json-e49b
                        library: Jackson
                  - setProperty:
                      id: setProperty-appKey
                      description: "Banco: bancoAppKey"
                      name: bancoAppKey
                      expression:
                        simple:
                          id: simple-3f62
                          expression: ${body[AppKey]}
                  - setProperty:
                      id: setProperty-ClientId
                      description: "Banco: bancoClientId"
                      name: bancoClientId
                      expression:
                        simple:
                          id: simple-d07d
                          expression: ${body[ClientId]}
                  - setProperty:
                      id: setProperty-ClientSecret
                      description: "Banco: bancoClientSecret"
                      name: bancoClientSecret
                      expression:
                        simple:
                          id: simple-e743
                          expression: ${body[ClientSecret]}
                  - setProperty:
                      id: setProperty-banco-certificado
                      description: "Banco: bancoCertificado"
                      name: bancoCertificado
                      expression:
                        simple:
                          id: simple-6994
                          expression: ${body[Certificado]}
                  - setProperty:
                      id: setProperty-banco-senhaCert
                      description: "Banco: bancoSenhaCertificado"
                      name: bancoSenhaCertificado
                      expression:
                        simple:
                          id: simple-a3c9
                          expression: ${body[Senha]}
                  - setProperty:
                      id: setProperty-banco-scopes
                      description: "Banco: bancoScopes"
                      name: bancoScopes
                      expression:
                        simple:
                          id: simple-0320
                          expression: ${body[Scopes]}
                  - to:
                      id: to-944f
                      uri: direct
                      parameters:
                        name: redis-auth2-token
            otherwise:
              id: otherwise-efaf
              steps:
                - log:
                    id: log-6c3f
                    message: "### ERRO CHAVE NAO ENCONTRADA###"
                - setHeader:
                    id: setHeader-nao-existe-banco
                    name: CamelHttpResponseCode
                    expression:
                      simple:
                        id: simple-b4d9
                        expression: "400"
                - setBody:
                    id: setBody-296e
                    expression:
                      simple:
                        id: simple-1504
                        expression: >-
                          { "erro": "Chaves do banco/Unimed não encontradas no
                          Vault",

                          "codigoBanco": ${exchangeProperty.rota[codigoBanco]}

                          }
                - stop:
                    id: stop-dados-bancarios
- route:
    id: redis-auth2-token
    from:
      id: from-redis-auth2-token
      uri: direct
      parameters:
        name: redis-auth2-token
      steps:
        - log:
            id: log-ab81
            message: "### ROUTE-REDIS-AUTH2-TOKEN####"
        - choice:
            id: choice-auth2-identifica-banco
            when:
              - id: when-auth2-bb
                description: Banco == 1
                expression:
                  simple:
                    id: simple-a0b6
                    expression: ${exchangeProperty.rota[codigoBanco]} == 1
                steps:
                  - setBody:
                      id: setBody-auth2-bb-scopes
                      expression:
                        simple:
                          id: simple-8bb0
                          expression: >-
                            grant_type=client_credentials&scopes:
                            ${exchangeProperty[bancoScopes]}
                  - setHeader:
                      id: setHeader-6d5f
                      description: Content-Type
                      name: Content-Type
                      expression:
                        simple:
                          id: simple-8e29
                          expression: application/x-www-form-urlencoded
                  - setHeader:
                      id: setHeader-7a86
                      name: Authorization
                      expression:
                        simple:
                          id: simple-e6a0
                          expression: Basic ${exchangeProperty.bancoClientSecret}
                  - toD:
                      id: to-req-oauth2-bb
                      uri: https
                      parameters:
                        httpUri: oauth.hm.bb.com.br/oauth/token
                        httpMethod: POST
                        bridgeEndpoint: true
                        logHttpActivity: false
                  - unmarshal:
                      id: unmarshal-recebe-token
                      json:
                        id: json-07e8
                  - log:
                      id: log-b807
                      message: ${body[access_token]}
                  - setProperty:
                      id: setProperty-2a48
                      description: "Variavel: tokenBancario"
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-0098
                          expression: ${body[access_token]}
                  - log:
                      id: log-4b78
                      message: "#####RECEBEU TOKEN  BANCO#######"
                  - log:
                      id: log-6f11
                      message: ${exchangeProperty.tokenBancario}
              - id: when-a865
                description: Banco == 33
                expression:
                  simple:
                    id: simple-c13b
                    expression: ${exchangeProperty.rota[codigoBanco]} == 33
                steps:
                  - log:
                      id: log-197f
                      message: "#### INICIO DE BUSCA TOKEN SANTANDER ####"
                  - stop:
                      id: stop-7100
                  - setBody:
                      id: setBody-2d3d
                      expression:
                        simple:
                          id: simple-a586
                          expression: >-
                            grant_type=client_credentials&client_secret:
                            ${exchangeProperty[bancoClientSecret]}&client_id:
                            ${exchangeProperty[bancoClientId]}
                  - setHeader:
                      id: setHeader-santander-content-type
                      name: Content-Type
                      expression:
                        simple:
                          id: simple-santander-content-type
                          expression: application/x-www-form-urlencoded
                  - setHeader:
                      id: setHeader-santander-ssl-certificate
                      name: CamelHttpClientCertificateStore
                      expression:
                        simple:
                          id: simple-santander-certificate
                          expression: ${exchangeProperty.bancoCertificado}
                  - setHeader:
                      id: setHeader-santander-ssl-password
                      name: CamelHttpClientCertificateStorePassword
                      expression:
                        simple:
                          id: simple-santander-certificate-password
                          expression: ${exchangeProperty.bancoSenhaCertificado}
                  - toD:
                      id: to-req-oauth2-santander
                      uri: https
                      parameters:
                        httpUri: api.santander.com.br/auth/oauth/v2/token
                        httpMethod: POST
                        bridgeEndpoint: true
                        logHttpActivity: true
                        useGlobalSslContextParameters: false
                  - unmarshal:
                      id: unmarshal-santander-token
                      json:
                        id: json-santander-token
                  - setProperty:
                      id: setProperty-santander-token
                      description: "Variavel: tokenBancario"
                      name: tokenBancario
                      expression:
                        simple:
                          id: simple-santander-token
                          expression: ${body[access_token]}
                  - log:
                      id: log-aca4
                      message: ${body}
                  - stop:
                      id: stop-ec69
            otherwise:
              id: otherwise-auth2-identifica-banco
              steps:
                - setHeader:
                    id: setHeader-1851
                    name: CamelHttpResponseCode
                    expression:
                      simple:
                        id: simple-26ed
                        expression: "400"
                - setBody:
                    id: setBody-5135
                    expression:
                      simple:
                        id: simple-ed61
                        expression: >-
                          { erro: "Banco não idetificado para busca do token
                          oAuth2",

                          "codigoBanco": ${exchangeProperty.rota[codigoBanco]}

                          }
                - stop:
                    id: stop-d54d
        - choice:
            id: choice-valida-recebeu-token
            disabled: false
            when:
              - id: when-e5fc
                description: RecebeuToken
                expression:
                  simple:
                    id: simple-9e45
                    expression: ${exchangeProperty.tokenBancario} != ""
                steps:
                  - log:
                      id: log-afe0
                      message: ${exchangeProperty.redisToken}
                  - setHeader:
                      id: setHeader-e778
                      name: CamelRedis.Key
                      expression:
                        simple:
                          id: simple-63a6
                          expression: ${exchangeProperty.redisToken}
                  - setHeader:
                      id: setHeader-6e15
                      name: CamelRedis.Timeout
                      expression:
                        simple:
                          id: simple-934c
                          expression: ${body[expires_in]}
                  - setHeader:
                      id: setHeader-9175
                      disabled: true
                      name: CamelRedis.Value
                      expression:
                        simple:
                          id: simple-32fe
                          expression: ${exchangeProperty.tokenBancario}
                  - setBody:
                      id: setBody-1cd4
                      disabled: false
                      expression:
                        simple:
                          id: simple-ecb2
                          expression: ${exchangeProperty.tokenBancario}
                  - to:
                      id: to-redis-set-token
                      description: CriaToken
                      uri: kamelet:redis-sink
                      parameters:
                        redisHost: fesc-sql-dev01.fesc.sgusuite.com.br
                        redisPort: 6379
                        command: SETEX
                  - log:
                      id: log-4a23
                      message: "####TOKEN-SALVO-BANCO#####"
            otherwise:
              id: otherwise-5ab6
              steps:
                - setBody:
                    id: setBody-retorno-erro-banco-token
                    expression:
                      simple:
                        id: simple-c0be
                        expression: ${body}
                - stop:
                    id: stop-678a
- route:
    id: route-valida-banco
    nodePrefixId: route-valida-banco
    from:
      id: from-redis-valida-token
      uri: direct
      parameters:
        name: valida-banco
      steps:
        - log:
            id: log-05db
            message: "#### ROUTE-VALIDA-BANCO ######"
        - setBody:
            id: setBody-96ff
            expression:
              simple:
                id: simple-b02e
                expression: ${exchangeProperty.dadosRecebidos}
        - bean:
            id: bean-4a67
            ref: montaPayload
            method: montarPayload
        - to:
            id: to-1155
            uri: direct
            parameters:
              name: bb-cobranca
- route:
    id: bb-cobranca
    nodePrefixId: route-ecf
    from:
      id: from-bb-cobranca
      uri: direct
      parameters:
        name: bb-cobranca
      steps:
        - log:
            id: log-4a6b
            message: "####ROUTE-BB-COBRANCA#####"
        - log:
            id: log-aa16
            message: "TOKEN: ${exchangeProperty.tokenBancario}"
        - setHeader:
            id: setHeader-content-type-bb-cobranca
            name: Content-Type
            expression:
              constant:
                id: constant-content-type-bb-cobranca
                expression: application/json
        - doTry:
            id: doTry-bb-cobranca
            doCatch:
              - id: doCatch-bb-cobranca
                exception:
                  - java.lang.Exception
                steps:
                  - setHeader:
                      id: setHeader-http-status
                      name: CamelHttpResponseCode
                      expression:
                        simple:
                          id: simple-http-status
                          expression: ${header.CamelHttpResponseCode}
                  - setBody:
                      id: setBody-erro
                      expression:
                        simple:
                          id: simple-erro
                          expression: ${exception.getResponseBody()}
                  - stop:
                      id: stop-erro
            steps:
              - log:
                  id: log-5e1d
                  message: ${body}
              - setHeader:
                  id: setHeader-authorization
                  name: Authorization
                  expression:
                    simple:
                      id: simple-authorization
                      expression: Bearer ${exchangeProperty.tokenBancario}
              - setHeader:
                  id: setHeader-gwkey
                  disabled: false
                  name: X-Developer-Application-Key
                  expression:
                    simple:
                      id: simple-gwkey
                      expression: 143851dc56ae48a794078dbe3c964d42
              - log:
                  id: log-c7e4
                  message: ${exchangeProperty.bancoAppKey}
              - choice:
                  id: choice-rota-saida
                  when:
                    - id: envio-bb-inclusao
                      expression:
                        simple:
                          id: simple-envio-bb-inclusao
                          expression: ${exchangeProperty.rota[tipo]} == "registrar"
                      steps:
                        - log:
                            id: log-aefa
                            message: "### ENVIANDO-INCLUSAO-COBRANCA-BB#####"
                        - toD:
                            id: toD-bb-cobranca
                            uri: https://api.hm.bb.com.br/cobrancas/v2/boletos
                            parameters:
                              httpMethod: POST
                              logHttpActivity: true
                              bridgeEndpoint: true
                              httpUri: https://api.hm.bb.com.br/cobrancas/v2/boletos
                        - setBody:
                            id: setBody-bb-aceito
                            expression:
                              simple:
                                id: simple-bb-aceito
                                expression: ${body}
                        - log:
                            id: log-response-success-inclusao
                            message: "Resposta BB: ${body}"
                            loggingLevel: INFO
                            logName: bb-cobranca
                    - id: envio-bb-alteracao
                      expression:
                        simple:
                          id: simple-envio-bb-alteracao
                          expression: ${exchangeProperty.rota[tipo]} != "registrar"
                      steps:
                        - toD:
                            id: toD-bb-cobranca-alteracao
                            uri: >-
                              https://api.hm.bb.com.br/cobrancas/v2/boletos/${exchangeProperty.dadosBoleto[numeroNossoNumero]}
                            parameters:
                              gwDevAppKey: ${exchangeProperty.appKey}
                              httpMethod: PATCH
                              logHttpActivity: false
                              bridgeEndpoint: false
                        - setBody:
                            id: setBody-bb-alteracao
                            expression:
                              simple:
                                id: simple-bb-alteracao
                                expression: ${body}
                        - log:
                            id: log-response-success-alteracao
                            message: "Resposta BB: ${body}"
                            loggingLevel: INFO
                            logName: bb-cobranca
                  otherwise:
                    id: otherwise-bb-operacao-desconhecida
                    steps:
                      - setHeader:
                          id: setHeader-bb-erro
                          name: CamelHttpResponseCode
                          expression:
                            simple:
                              id: simple-status-erro-bb
                              expression: "400"
                      - setBody:
                          id: setBody-bb-erro
                          expression:
                            simple:
                              id: simple-erro-operacao
                              expression: |
                                {
                                  "mensagem": "Operação não suportada: ${exchangeProperty.rota[tipo]}"
                                }
